/**
 * eon.jquery.servicepointer ~ Version 1.30.0
 * @author    Serge Jamasb
 * @copyright the author
 * @license  MIT/GPL
 */

!function(t,e){function n(t){return isNaN(t)?0:t*Math.PI/180}function o(e){return"undefined"===e&&(e="Ready"),0===t("#tracie").length&&t("#search-form").append('<span id="tracie" style="color: silver;margin-left: 5px;"></span>'),t("#tracie").text(e)}ServicePointer={icon:"",lang:{},map:"",a:[],b:null,services:{get_nearest_service_points:"",get_service_point_hours:"",set_service_point:""},c:{nearest_service_points:{},service_point_hours:{}},d:"",e:"",f:!1,is_busy:!1,init:function(t,e,n){this.e=n,this.d=t;var o={mapTypeId:google.maps.MapTypeId.ROADMAP,zoom:12},a=e.list&&e.list.length&&e.coords.length;a&&(o.center=new google.maps.LatLng(e.coords[0][0],e.coords[0][1])),this.map=new google.maps.Map(document.getElementById("map-canvas"),o),this.geocoder=new google.maps.Geocoder,this.g(),a&&this.h(e)},h:function(e){if("undefined"!=typeof e&&(this.b=e),!this.b.list.length||!this.b.coords.length)return o(this.lang["No results found"]);this.i(),this.j();var n=new google.maps.LatLngBounds;t.each(this.b.coords,function(t,e){latLng=new google.maps.LatLng(e[0],e[1]),n.extend(latLng)}),_map=this.map,_map.panToBounds(n),1==this.b.coords.length?this.map.panTo(new google.maps.LatLng(this.b.coords[0][0],this.b.coords[0][1])):setTimeout(function(){_map.fitBounds(n)},600)},g:function(){var e=this;t("#search-form").live("submit",function(n){n.preventDefault(),n.stopPropagation();var a=t("#postcode").val().trim(),i=t("#city").val().trim(),s=i.toLowerCase()+a,r=e.f;return e.f=!1,o(""),"undefined"!=typeof e.c.nearest_service_points[s]?e.h(e.c.nearest_service_points[s]):void t.get(e.services.get_nearest_service_points,{postcode:a,city:i},function(t){"undefined"!=typeof t.coords?(e.c.nearest_service_points[s]=t,e.h(t)):r&&o(e.lang["No results found"])})});var n=t("#postcode, #city");n.live("keydown",function(){e.f=!0,n.filter(":not(#"+this.id+")").val("")}),t("#poi li .button").live("click",function(){var n=t(this).closest("li");t.post(e.services.set_service_point,{service_point_id:n.data("servicepointid"),sp_type:n.data("sptype")},function(n){try{if(parent.$("#form").length)parent.$.fancybox.close();else{var o=0,a=0,i="",s=parent.$(".delivery_option_radio"),r="&";t.each(s,function(e){t(this).prop("checked")&&(r+=parent.$(s[e]).attr("name")+"="+parent.$(s[e]).val()+"&")}),"&"==r&&(r="&delivery_option=&"),parent.$("input#recyclable:checked").length&&(o=1),parent.$("input#gift:checked").length&&(a=1,i=encodeURIComponent(parent.$("#gift_message").val())),t.post(parent.orderOpcUrl,{ajax:!0,gift:a,gift_message:i,id_carrier:parseInt(parent.$('[name="id_carrier"], .delivery_option_radio').filter(":checked").val(),10),method:"updateCarrierAndGetPayments",rand:(new Date).getTime(),recyclable:o},function(n){if(n.hasError){var o="";for(var a in n.errors)"indexOf"!==a&&(o+=t("<div />").html(n.errors[a]).text()+"\n");alert(o)}else parent.updateCartSummary(n.summary),parent.updatePaymentMethods(n),parent.updateHookShoppingCart(n.HOOK_SHOPPING_CART),parent.updateHookShoppingCartExtra(n.HOOK_SHOPPING_CART_EXTRA),parent.$("#opc_delivery_methods-overlay, #opc_payment_methods-overlay").fadeOut("slow"),e.d>1.4&&(parent.updateCarrierList(n.carrier_data),parent.refreshDeliveryOptions());parent.$.fancybox.close()},"JSON")}}catch(p){parent.$("#fancybox-overlay").hide(),parent.$("#fancybox-wrap").hide()}},"JSON")}),t("#poi li").live("click",function(n){if(!t(n.target).is(".button")&&!e.is_busy){t(n.target).is("a")&&(n.preventDefault(),n.stopPropagation());var o=t(this),a=o.find(".hours");if(o.siblings().removeClass("active").find(".hours").hide(),o.toggleClass("active"),a.length)a.toggle();else switch(e.e){case 2:if("undefined"!=typeof e.c.service_point_hours[o.data("servicepointid")])return e.k(e.c.service_point_hours[o.data("servicepointid")],o);t.get(e.services.get_service_point_hours,{service_point_id:o.data("servicepointid"),sp_type:o.data("sptype")},function(t){t&&(e.c.service_point_hours[o.data("servicepointid")]=t,e.k(t,o))});break;case 4:$button=t("<a />").addClass("button").text(e.lang["Next step"]),t('<div class="hours" />').append($button).insertAfter(o.find("a"))}setTimeout(function(){t("#poi").animate({scrollTop:o.position().top},"500","swing")},800)}}),google.maps.event.addListener(this.map,"dragstart",function(){var t=e.map;e.start_center=t.getCenter()}),google.maps.event.addListener(this.map,"dragend",function(){var n=e.map,o=e.geocoder,a=n.getCenter();o.geocode({latLng:a},function(e,n){n==google.maps.GeocoderStatus.OK&&(post_code="",city="",not_belgium=!0,no_postcode=!0,t.each(e,function(e,n){return t.each(n.address_components,function(t,e){return not_belgium?not_belgium="BE"!==e.short_name:"postal_code"===e.types[0]&&(post_code=e.short_name,no_postcode=""===post_code),no_postcode}),not_belgium}),no_postcode||(t("#city").val(city),t("#postcode").val(post_code),t("input[name=searchSubmit]").trigger("click")))})})},i:function(){if(this.b.list.length){var e,n=this,o=t("#poi"),a=o.children("li").first().clone();o.empty(),a.removeClass("active hidden"),t.each(this.b.list,function(i,s){e=a.clone(!0),e.data("servicepointid",s.id).attr("data-servicepointid",s.id).data("sptype",s.type).attr("data-sptype",s.type).find("a").attr("title",s.office).click(function(){n.l(i)}).end().find(".details").empty().append(t("<span />").addClass("name").text(s.office),s.street+" "+s.nr,"<br />",s.zip+" "+s.city).end().find(".hours").remove(),o.append(e)})}},j:function(){var e=this;e.b.coords.length&&(e.m(),t.each(e.b.coords,function(t,n){setTimeout(function(){e.n(n)},50*t)}))},n:function(e){var n=this,o=new google.maps.Marker({animation:google.maps.Animation.DROP,icon:n.icon,map:n.map,position:new google.maps.LatLng(e[0],e[1])});n.a.push(o);var a=[];google.maps.event.addListener(o,"click",function(){var e=5;a.push(parseFloat(o.position.lat().toFixed(e))),a.push(parseFloat(o.position.lng().toFixed(e)));var i,s;for(i=0,s=n.b.coords.length;s>i&&(0!=t(n.b.coords[i]).not(a).length||0!=t(a).not(n.b.coords[i]).length);i++);s>i&&(t(t("#poi li").get(i)).trigger("click"),n.l(i))})},m:function(){var t;for(t=0;t<this.a.length;t++)this.a[t].setMap(null);this.a=[]},l:function(e){var n=this,o=n.a[e],a=google.maps.Animation.BOUNCE;"undefined"!=typeof o&&null!==o.getAnimation()&&(a=null),t(n.a).each(function(){this.setAnimation(null)}),o.setAnimation(a)},k:function(e,n){var o,a=this,i=t('<div class="hours" />'),s=t("<table />"),r=t("<a />").addClass("button").text(a.lang["Next step"]);e&&(t.each(e,function(e,n){o=t("<tr />"),t.isEmptyObject(n.am_open)||t.isEmptyObject(n.pm_open)?t.isEmptyObject(n.am_open)||t.isEmptyObject(n.pm_close)?t.isEmptyObject(n.am_open)||t.isEmptyObject(n.am_close)||!t.isEmptyObject(n.pm_open)?t.isEmptyObject(n.pm_open)&&t.isEmptyObject(n.pm_close)?o.addClass("two-cols").append('<td class="day">'+a.lang[e]+'</td><td colspan="2">'+a.lang.Closed+"</td>"):o.addClass("two-cols").append('<td class="day">'+a.lang[e]+'</td><td colspan="2">'+n.pm_open+(t.isEmptyObject(n.pm_close)?"":" - "+n.pm_close)+"</td>"):o.addClass("two-cols").append('<td class="day">'+a.lang[e]+'</td><td colspan="2">'+n.am_open+" - "+n.am_close+"</td>"):o.addClass("two-cols").append('<td class="day">'+a.lang[e]+'</td><td colspan="2">'+n.am_open+" - "+n.pm_close+"</td>"):o.append('<td class="day">'+a.lang[e]+"</td><td>"+n.am_open+(t.isEmptyObject(n.am_close)?"":" - "+n.am_close)+"</td><td>"+n.pm_open+(t.isEmptyObject(n.pm_close)?"":" - "+n.pm_close)+"</td>"),s.append(o)}),i.append(s)),i.append(r).insertAfter(n.find("a"))},mapDistance:function(t){if(0==this.start_center.length)return 0;var e=this,n=e.map,o=n.getProjection();return point_prev=o.fromLatLngToPoint(e.start_center),point_now=o.fromLatLngToPoint(t),dist=Math.sqrt(Math.pow(2,point_now.x-point_prev.x)+Math.pow(2,point_now.y-point_prev.y)),dist},distanceMoved:function(t){if(0==this.start_center.length)return 0;var e=this.start_center.lat(),o=this.start_center.lng(),a=t.lat(),i=t.lng(),s=n(e),r=n(a),p=n(a-e)/2,c=n(i-o)/2,d=6371,l=Math.sin(p)*Math.sin(p)+Math.cos(s)*Math.cos(r)*Math.sin(c)*Math.sin(c),h=2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l));return d*h}}}(jQuery);